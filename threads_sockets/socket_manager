import socket
import pickle
import pandas as pd
from sql_connection import get_connection, get_data

def main():
    # 1. Obtener datos de la BD
    cnx = get_connection()
    data = get_data(cnx, "SELECT * FROM UN.VENTAS LIMIT 1000")
    df = pd.DataFrame(data, columns=[
        'ID_VENTA', 'FECHA_VENTA', 'ID_CLIENTE', 'ID_EMPLEADO',
        'ID_PRODUCTO', 'CANTIDAD', 'PRECIO_UNITARIO', 'DESCUENTO', 'FORMA_PAGO'
    ])
    cnx.close()
    
    # 2. Conectar al servidor
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
        sock.connect(('localhost', 8080))
        
        # 3. Enviar datos
        sock.sendall(pickle.dumps(df))
        print("üì§ Datos enviados al servidor")
        
        # 4. Recibir resultados
        results = pickle.loads(sock.recv(65536))
        
        if 'error' in results:
            print(f"‚ùå Error: {results['error']}")
            return
        
        # 5. Procesar resultados
        print("\nResultados de ordenamiento:")
        for algo, data in results.items():
            print(f"{algo}: {data['time']:.4f} segundos")
            # Guardar resultados
            pd.DataFrame(data['result']).to_csv(f'sorted_{algo}.csv', index=False)

if __name__ == "__main__":
    main()